# 文件管理功能说明

## 📋 功能概述

新增了完整的文件管理功能，允许用户删除历史检测记录，避免文件积累过多占用存储空间。

---

## ✨ 功能特性

### 1️⃣ 单个删除
- 每条记录旁边都有"删除"按钮
- 点击后会弹出确认对话框，防止误删
- 删除一条记录会自动清理所有相关文件

### 2️⃣ 批量删除
- 使用复选框选择多条记录
- 选中后会出现"删除选中"按钮
- 显示选中数量，如"删除选中 (3)"
- 批量删除前会二次确认

### 3️⃣ 清空全部
- 一键清空所有历史记录
- 需要两次确认，防止误操作
- 清空后页面自动刷新

### 4️⃣ 全选功能
- 表头有全选复选框
- 可快速选中或取消所有记录

---

## 🗑️ 删除内容

删除一条记录时，系统会自动清理以下所有相关文件：

1. **检测结果** - `{task_id}_results.json`
2. **PDF报告** - `{task_id}_report.pdf`
3. **可视化图像**:
   - 预览图 `{task_id}_preview.png`
   - 汇总图 `{task_id}_summary.png`
   - 叠加图 `{task_id}_overlay.png`
   - 切片图 `{task_id}_original_slices.png`
   - 验证图 `{task_id}_validation.png`
4. **上传的原始文件** - `{task_id}_*.mhd`, `{task_id}_*.nrrd` 等

---

## 🎯 使用方法

### 方法1：删除单个记录

1. 访问 **历史记录** 页面
2. 找到要删除的记录
3. 点击该记录右侧的 **"删除"** 按钮
4. 在确认对话框中点击 **"确定"**
5. 记录会淡出消失，相关文件已删除

### 方法2：批量删除

1. 访问 **历史记录** 页面
2. 勾选要删除的记录（可勾选多个）
3. 点击顶部的 **"删除选中"** 按钮
4. 确认删除操作
5. 所有选中的记录将被删除

### 方法3：清空全部

1. 访问 **历史记录** 页面
2. 点击顶部的 **"清空全部"** 按钮
3. **第一次确认**：确认要清空所有记录
4. **第二次确认**：再次确认（防止误操作）
5. 所有历史记录将被清空

---

## ⚠️ 注意事项

### 重要提示

1. **删除操作不可恢复** - 一旦删除，所有相关数据将永久丢失
2. **批量操作需谨慎** - 清空全部前请确保不需要这些数据
3. **确认对话框** - 请仔细阅读确认信息后再操作

### 安全机制

- ✅ 单个删除：1次确认
- ✅ 批量删除：1次确认  
- ✅ 清空全部：**2次确认**（额外保护）

### 删除确认示例

**单个删除**：
```
确定要删除 "test.nrrd" 的检测记录吗？

此操作将删除所有相关文件（结果、报告、图像等），且不可恢复！
```

**清空全部**：
```
⚠️ 危险操作！

确定要清空全部 15 条检测记录吗？

此操作将永久删除所有检测数据、报告和图像，且不可恢复！
```

---

## 🔄 操作反馈

### 成功提示
删除成功后，页面右上角会显示绿色提示框：
```
✓ 删除成功！
```

### 失败提示
如果删除失败，会显示红色提示框并说明原因：
```
✗ 删除失败：[错误信息]
```

### 动画效果
- 删除成功的记录会淡出消失（300ms动画）
- 批量删除有加载状态："删除中..."
- 清空全部完成后自动刷新页面

---

## 🛠️ 技术实现

### 后端API

**1. 删除单个记录**
```
DELETE /api/delete/<task_id>
```

**2. 批量删除**
```
POST /api/delete_batch
Body: { "task_ids": ["id1", "id2", ...] }
```

**3. 清空全部**
```
POST /api/clear_all
```

### 前端功能

- jQuery + AJAX 实现异步删除
- Bootstrap 5 样式
- Font Awesome 图标
- 动画效果优化用户体验

---

## 📂 文件存储位置

删除功能会清理以下目录：

| 目录 | 内容 |
|------|------|
| `system_results/` | 检测结果JSON、PDF报告 |
| `visualizations/` | 所有可视化图像 |
| `uploads/` | 上传的原始CT图像 |

---

## 💡 使用建议

### 何时删除记录？

1. **测试数据** - 测试完成后及时删除
2. **错误检测** - 检测失败或结果不正确的记录
3. **重复数据** - 同一文件多次检测产生的冗余记录
4. **定期清理** - 建议每月清理不需要的历史记录

### 删除前的检查

在删除重要记录前：
- ✅ 确认已下载需要保存的PDF报告
- ✅ 确认已备份需要的可视化图像
- ✅ 确认不再需要该检测结果

---

## 🚀 快捷键（未来功能）

计划添加的快捷键：
- `Ctrl + A` - 全选
- `Delete` - 删除选中
- `Ctrl + Shift + Delete` - 清空全部

---

## 📊 统计信息

删除操作会返回以下信息：

**单个删除**：
```json
{
  "success": true,
  "message": "记录已删除",
  "deleted_files": [
    "results.json",
    "report.pdf",
    "preview.png",
    "summary.png",
    ...
  ]
}
```

**批量删除**：
```json
{
  "success": true,
  "deleted_count": 5,
  "failed_count": 0,
  "message": "成功删除 5 条记录"
}
```

---

## ❓ 常见问题

### Q1: 删除后能恢复吗？
**A:** 不能。删除操作会永久删除所有相关文件，无法恢复。请在删除前确认。

### Q2: 删除失败怎么办？
**A:** 
1. 检查文件权限
2. 确认文件未被其他程序占用
3. 查看系统日志获取详细错误信息
4. 重新启动系统后重试

### Q3: 能只删除部分文件吗？
**A:** 不能。为保持数据一致性，删除操作会清理该记录的所有相关文件。

### Q4: 清空全部后历史记录页面显示什么？
**A:** 页面会显示"暂无历史记录"的提示，并引导您开始新的检测。

---

## 🔐 权限说明

- 删除操作不需要额外权限
- 任何能访问系统的用户都可以删除记录
- 建议在生产环境中添加用户认证和权限管理

---

## 📝 更新日志

**版本 1.0** (2025-10-22)
- ✅ 新增单个删除功能
- ✅ 新增批量删除功能
- ✅ 新增清空全部功能
- ✅ 新增全选/取消全选功能
- ✅ 添加删除确认对话框
- ✅ 添加操作反馈提示
- ✅ 优化用户体验和动画效果

---

## 📧 反馈与建议

如有问题或建议，欢迎反馈。

---

**警告：删除操作不可恢复，请谨慎操作！** ⚠️


