# 🫁 TiCNet 肺结节检测系统使用说明

## ✅ 系统功能

本系统支持对肺部CT图像进行智能结节检测，并自动显示LUNA16真实标注框（如果有）。

---

## 📁 支持的文件格式

### ⭐ 推荐格式（完整支持）

1. **NRRD格式** (.nrrd, .nhdr)
   - ✅ 单文件，方便上传
   - ✅ 完整保留spacing、origin等空间信息
   - ✅ **可以显示LUNA16真实标注框**
   - 📝 推荐指数：⭐⭐⭐⭐⭐

2. **MHD格式** (.mhd + .raw)
   - ✅ 完整保留空间信息
   - ✅ **可以显示LUNA16真实标注框**
   - ⚠️ 需要同时上传两个文件
   - 📝 推荐指数：⭐⭐⭐⭐

3. **NIfTI格式** (.nii, .nii.gz)
   - ✅ 完整保留空间信息
   - ✅ **可以显示LUNA16真实标注框**
   - 📝 推荐指数：⭐⭐⭐⭐

### 🔶 基础支持

4. **DICOM格式** (.dcm)
   - ✅ 医学标准格式
   - ✅ 保留空间信息

5. **NumPy格式** (.npy)
   - ⚠️ 仅支持3D数组
   - ❌ **无法显示真实标注框**（缺少空间信息）
   - 📝 仅用于简单测试

---

## 🚀 使用步骤

### 1. 启动系统

```bash
cd /home/yangao/LUNG/TiCNet
python run_system.py
```

启动后访问：`http://localhost:5000`

### 2. 上传文件

#### 方式A: NRRD文件（推荐）

1. 点击"选择CT图像文件"
2. 选择 `.nrrd` 文件（例如：`1.3.6.1.4.1.14519.5.2.1.6279.6001.xxx.nrrd`）
3. 点击"开始智能检测"

#### 方式B: MHD文件

1. 点击"选择CT图像文件"
2. **按住Ctrl键**，同时选择 `.mhd` 和 `.raw` 两个文件
3. 点击"开始智能检测"

### 3. 查看结果

系统会显示：
- 🔴 **红色框**：模型检测的结节
- 🟢 **绿色虚线框**：LUNA16真实标注（如果有）
- 📊 统计信息
- 🤖 AI智能分析

---

## 🎯 LUNA16真实标注框显示条件

### ✅ 会显示真实框的情况：

1. **文件类型正确**
   - NRRD格式文件
   - MHD格式文件（带.raw）
   - NIfTI格式文件

2. **文件名包含SeriesUID**
   - 例如：`1.3.6.1.4.1.14519.5.2.1.6279.6001.997611074084993415992563148335.nrrd`
   - SeriesUID用于查找annotations.csv中的标注

3. **Origin信息正确**
   - Origin通常是较大的负数，如 `(-375.0, -242.0, -347.0)`
   - 系统会自动验证origin是否合理

4. **标注文件存在**
   - `annotations/annotations.csv` 文件存在
   - CSV中包含该SeriesUID的标注记录

### ❌ 不会显示真实框的情况：

1. **文件格式不支持**
   - ❌ `.npy` 文件（缺少origin、spacing信息）
   - ❌ `.png`, `.jpg` 等普通图像

2. **Origin接近(0,0,0)**
   - 这通常表示是预处理后的图像
   - 原始LUNA16图像的origin是大的负数

3. **文件名不包含SeriesUID**
   - 无法匹配annotations.csv中的记录

4. **CSV中没有对应标注**
   - 有些CT图像本身就没有结节标注

---

## 📊 示例文件

### ✅ 正确示例

```bash
# NRRD格式（推荐）
1.3.6.1.4.1.14519.5.2.1.6279.6001.997611074084993415992563148335.nrrd

# MHD格式（需要两个文件）
1.3.6.1.4.1.14519.5.2.1.6279.6001.997611074084993415992563148335.mhd
1.3.6.1.4.1.14519.5.2.1.6279.6001.997611074084993415992563148335.raw
```

### ❌ 不推荐示例

```bash
# .npy文件无法显示真实框
patient001.npy

# 预处理后的文件（origin被重置）
patient001_seg.nrrd
```

---

## 🔧 MHD转NRRD转换

如果您只有MHD文件，可以使用以下脚本转换为NRRD：

```python
# convert_mhd_to_nrrd.py
import SimpleITK as sitk
import sys

if len(sys.argv) != 3:
    print("用法: python convert_mhd_to_nrrd.py input.mhd output.nrrd")
    sys.exit(1)

mhd_path = sys.argv[1]
nrrd_path = sys.argv[2]

# 读取MHD文件
image = sitk.ReadImage(mhd_path)

# 保存为NRRD格式
sitk.WriteImage(image, nrrd_path)

print(f"✓ 转换完成: {mhd_path} → {nrrd_path}")
```

使用方法：

```bash
python convert_mhd_to_nrrd.py input.mhd output.nrrd
```

---

## 🎨 界面功能

### 主页
- 📤 文件上传
- 👁️ 实时预览
- 🚀 智能检测

### 结果页
- 📊 检测统计
- 🖼️ 可视化结果
- 📝 在线报告

### 历史记录
- 📜 查看所有检测记录
- 🗑️ 删除单个/批量/全部记录

### 报告页面
- 📄 详细检测报告
- 🤖 AI智能分析
- 📥 PDF下载（可选）

---

## ⚠️ 常见问题

### Q1: 为什么看不到绿色真实框？

**A:** 检查以下几点：
1. 文件格式是否是NRRD/MHD/NIfTI？
2. 文件名是否包含完整的SeriesUID？
3. Origin是否是大的负数？（在日志中查看）
4. annotations.csv中是否有对应记录？

### Q2: 上传.npy文件能显示真实框吗？

**A:** 不能。.npy文件缺少origin和spacing信息，无法进行世界坐标到体素坐标的转换。请使用NRRD或MHD格式。

### Q3: MHD文件上传后报错？

**A:** 确保同时上传了.mhd和.raw两个文件。按住Ctrl键可以多选。

### Q4: 如何获取NRRD格式文件？

**A:** 
- 从LUNA16官方下载NRRD格式
- 使用SimpleITK将MHD转换为NRRD
- 使用3D Slicer软件转换

---

## 📞 技术支持

如遇到问题，请检查：
1. 终端日志输出
2. 浏览器控制台错误
3. 文件格式和命名

**系统已优化为处理NRRD格式文件，推荐使用！** ✨






