# NRRD文件预览功能使用指南

## 功能概述

新增的NRRD文件预览功能允许您在进行完整的肺结节检测之前，先快速查看上传的CT图像。这个功能特别适用于：

- ✅ 确认上传的文件是否正确
- ✅ 检查图像质量和内容
- ✅ 快速浏览CT扫描的不同切片
- ✅ 节省不必要的检测时间

## 功能特点

### 1. 快速预览
- 自动生成3x3网格的切片预览
- 显示从头到尾均匀分布的9个代表性切片
- 显示图像的完整尺寸信息（深度×高度×宽度）

### 2. 两种使用模式

#### 模式一：先预览后检测
1. 上传NRRD文件
2. 点击"预览图像"按钮
3. 查看生成的切片预览
4. 确认无误后，点击"继续进行智能检测"

#### 模式二：直接检测
1. 上传NRRD文件
2. 直接点击"开始智能检测"按钮
3. 跳过预览步骤

## Web界面使用步骤

### 步骤1：启动系统
```bash
python run_system.py
```

### 步骤2：访问Web界面
在浏览器中打开：http://localhost:5000

### 步骤3：上传文件
1. 点击"选择CT图像文件"按钮
2. 选择您的NRRD文件（或其他支持的格式）
3. 系统会显示文件信息（名称、大小、类型）

### 步骤4：预览图像（可选）
1. 点击"预览图像"按钮
2. 等待几秒钟
3. 查看生成的多切片预览图像
4. 确认图像正确

### 步骤5：开始检测
- 如果已预览：点击"继续进行智能检测"
- 如果未预览：直接点击"开始智能检测"

### 步骤6：查看结果
系统会自动跳转到结果页面，显示：
- 检测到的结节位置
- 置信度分数
- 可视化结果
- 统计信息

## 命令行测试

我们提供了一个独立的测试脚本，用于快速测试预览功能：

```bash
# 基本用法
python test_preview.py /path/to/your/file.nrrd

# 示例
python test_preview.py uploads/sample.nrrd
```

测试脚本会：
1. 检查文件是否存在
2. 加载NRRD文件
3. 生成预览图像
4. 报告生成结果和文件位置
5. 显示图像尺寸信息

## API接口

### 预览接口
- **URL**: `/preview`
- **方法**: POST
- **Content-Type**: multipart/form-data
- **参数**: 
  - `file`: NRRD文件（或其他支持的格式）

**请求示例**:
```javascript
const formData = new FormData();
formData.append('file', fileInput.files[0]);

fetch('/preview', {
    method: 'POST',
    body: formData
})
.then(response => response.json())
.then(data => {
    if (data.success) {
        console.log('任务ID:', data.task_id);
        console.log('预览图像:', data.preview_path);
        console.log('文件名:', data.filename);
    }
});
```

**响应格式**:
```json
{
    "success": true,
    "task_id": "uuid-string",
    "preview_path": "task_id_preview.png",
    "filename": "original_filename.nrrd"
}
```

### 可视化文件访问
- **URL**: `/visualization/<filename>`
- **方法**: GET
- **说明**: 用于访问生成的预览图像

## 支持的文件格式

预览功能支持以下格式：
- ✅ NRRD (.nrrd, .nhdr)
- ✅ MetaImage (.mhd + .raw)
- ✅ NIfTI (.nii, .nii.gz)
- ✅ DICOM (.dcm)
- ✅ 常规图像 (.png, .jpg, .jpeg)

## 技术实现

### 后端实现
- 使用 SimpleITK 或 pynrrd 读取NRRD文件
- 自动归一化图像数据到0-255范围
- 使用matplotlib生成切片网格
- 保存为PNG格式便于Web显示

### 前端实现
- 使用jQuery处理AJAX请求
- 动态显示/隐藏预览区域
- 平滑滚动到预览图像位置
- 响应式图像显示

## 预览图像说明

生成的预览图像包含：
- **网格布局**: 3行 × 3列，共9个切片
- **切片选择**: 从头到尾均匀分布
- **标题信息**: 每个切片显示其索引和在扫描中的位置百分比
- **总标题**: 显示完整的图像尺寸信息
- **灰度显示**: 使用标准的医学图像灰度色图

### 预览图像示例结构
```
┌─────────────────────────────────────────┐
│  CT图像预览 - 形状: 133×512×512         │
├─────────┬─────────┬─────────┐
│ 切片 0  │ 切片 16 │ 切片 33 │
│ (0.0%)  │ (12.0%) │ (24.8%) │
├─────────┼─────────┼─────────┤
│ 切片 49 │ 切片 66 │ 切片 82 │
│ (36.8%) │ (49.6%) │ (61.7%) │
├─────────┼─────────┼─────────┤
│ 切片 99 │切片 116 │切片 132 │
│ (74.4%) │ (87.2%) │(100.0%) │
└─────────┴─────────┴─────────┘
```

## 性能考虑

- **预览生成时间**: 通常 2-5 秒
- **图像文件大小**: 约 200-500 KB
- **内存使用**: 取决于原始NRRD文件大小
- **缓存策略**: 预览图像保存在 `visualizations/` 目录

## 常见问题

### Q1: 预览图像显示空白或黑色？
**A**: 可能是图像数据范围问题。系统会自动进行归一化处理，使用1%-99%百分位数裁剪异常值。

### Q2: 预览生成失败？
**A**: 检查以下几点：
- 文件格式是否正确
- 文件是否损坏
- SimpleITK 或 pynrrd 是否正确安装
- 查看控制台日志获取详细错误信息

### Q3: 预览很慢？
**A**: 
- 大文件（>100MB）可能需要更长时间
- 考虑使用较小的测试数据
- 确保系统有足够的内存

### Q4: 可以调整预览的切片数量吗？
**A**: 可以！编辑 `system/visualization.py` 中的 `create_preview` 方法，修改 `num_slices = min(9, depth)` 这一行。

## 文件位置

- **预览图像保存位置**: `visualizations/`
- **上传文件保存位置**: `uploads/`
- **可视化配置**: `system/config.py`
- **预览逻辑**: `system/visualization.py` → `create_preview()`
- **API路由**: `app.py` → `/preview` 端点

## 更新日志

### v1.0 (当前版本)
- ✅ 实现基础预览功能
- ✅ 支持NRRD等多种格式
- ✅ 添加Web界面集成
- ✅ 提供独立测试脚本
- ✅ 自动图像归一化
- ✅ 响应式UI设计

## 下一步计划

- [ ] 添加交互式切片浏览器（滑动条）
- [ ] 支持实时窗宽窗位调整
- [ ] 添加3D体积渲染预览
- [ ] 支持多文件批量预览
- [ ] 添加预览图像的放大/缩放功能

## 技术支持

如有问题或建议，请查看：
- 主README: `README.md`
- 系统文档: `SYSTEM_README.md`
- 控制台日志: 运行时的输出信息

---

**享受使用TiCNet肺结节检测系统！** 🫁

