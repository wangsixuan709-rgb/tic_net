# TiCNet 系统功能更新说明

## 更新时间
2025-10-22

## 更新内容

### 1. 检测置信度阈值调整 ✅

**修改说明：**
- 将检测框显示的置信度阈值从 **0.3** 提升至 **0.7**
- 只有置信度 ≥ 0.7 的检测结果会在可视化图像中显示检测框
- 这有助于减少误报，提高检测结果的可靠性

**影响文件：**
- `system/config.py` - 修改 `INFERENCE_CONFIG['min_confidence']`
- `system/visualization.py` - 在三处可视化函数中添加置信度过滤
- `templates/results.html` - 更新前端显示的阈值信息

**注意事项：**
- 所有检测结果（包括低置信度）仍会保存在结果JSON文件中
- 可视化图像和报告中只显示高置信度（≥0.7）的检测框
- 用户仍可在详细结果表格中查看所有检测结果

---

### 2. PDF分析报告生成功能 ✅

**功能描述：**
新增了检测结果分析报告自动生成功能，用户可以在检测完成后一键生成专业的PDF格式分析报告。

**报告内容包括：**
1. **报告头部**
   - 文件名、检测时间、任务ID
   - 模型信息

2. **检测结果摘要**
   - 检测结节总数
   - 各置信度等级结节数量
   - 平均置信度和体积

3. **图像与检测参数**
   - 图像尺寸、像素间距
   - 检测算法、置信度阈值
   - 推理时间

4. **详细检测结果表格**
   - 序号、置信度、位置、大小、体积、风险等级
   - 显示前20个最重要的检测结果

5. **可视化结果**
   - 检测结果汇总图
   - 叠加可视化图
   - 原始切片图

6. **验证结果**（如果有标注）
   - 正确检测、误报、漏检统计
   - 精度、召回率、F1分数
   - 平均IoU

7. **医学建议与注意事项**
   - 系统使用建议
   - 临床应用注意事项
   - 免责声明

**新增文件：**
- `system/report_generator.py` - 报告生成核心模块

**修改文件：**
- `app.py` - 添加报告生成相关路由
  - `/generate_report/<task_id>` - 生成并下载报告
  - `/api/generate_report/<task_id>` - API接口
  - `/download_report/<filename>` - 下载已生成的报告

- `templates/results.html` - 添加"生成报告"按钮及相关JS代码

**技术特性：**
- 支持中英文双语报告（自动检测中文字体）
- 使用ReportLab库生成高质量PDF
- 自动嵌入可视化图像
- 专业的排版和配色方案
- A4纸张尺寸，适合打印

---

## 安装新依赖

报告生成功能需要安装 `reportlab` 库：

```bash
# 方式1：单独安装
pip install reportlab==4.0.7

# 方式2：从requirements.txt安装
pip install -r requirements.txt
```

### 中文字体支持（可选）

如果需要生成包含中文的PDF报告，请确保系统中安装了中文字体。

**Linux系统：**
```bash
# Ubuntu/Debian
sudo apt-get install fonts-wqy-zenhei fonts-wqy-microhei

# 或者运行项目提供的脚本
bash 安装中文字体.sh
```

**系统会自动检测可用字体：**
- 如果找到中文字体，将生成中文报告
- 如果没有中文字体，将自动降级为英文报告

**支持的中文字体路径：**
- `/usr/share/fonts/truetype/wqy/wqy-zenhei.ttc`
- `/usr/share/fonts/truetype/wqy/wqy-microhei.ttc`
- `/usr/share/fonts/truetype/droid/DroidSansFallbackFull.ttf`
- `/usr/share/fonts/opentype/noto/NotoSansCJK-Regular.ttc`

---

## 使用方法

### 1. 检测置信度阈值调整

无需额外操作，系统会自动使用新的阈值（0.7）进行检测和可视化。

### 2. 生成分析报告

**方式1：通过Web界面**
1. 进行CT图像检测
2. 在检测结果页面点击"生成报告"按钮
3. 系统会自动生成PDF报告并开始下载

**方式2：通过API**
```bash
# 生成报告
curl -X POST http://localhost:5000/api/generate_report/<task_id>

# 下载报告
curl -o report.pdf http://localhost:5000/download_report/<report_filename>
```

**报告文件位置：**
- 生成的报告保存在 `system_results/` 目录
- 文件名格式：`<task_id>_report.pdf`

---

## 配置说明

### 修改置信度阈值

如需调整置信度阈值，编辑 `system/config.py`：

```python
self.INFERENCE_CONFIG = {
    'min_confidence': 0.7,  # 修改这个值
    'nms_threshold': 0.1,
    'max_detections': 100,
    'crop_size': [128, 128, 128],
    'stride': 4
}
```

**建议值：**
- `0.7` - 高精度模式（推荐，减少误报）
- `0.5` - 平衡模式
- `0.3` - 高召回模式（可能增加误报）

---

## 测试验证

### 测试报告生成功能

```bash
cd /home/yangao/LUNG/TiCNet

# 1. 安装依赖
pip install reportlab

# 2. 启动系统
python run_system.py

# 3. 进行一次检测

# 4. 在结果页面点击"生成报告"按钮

# 5. 检查生成的PDF报告
ls -lh system_results/*_report.pdf
```

### 预期结果

- ✅ 可视化图像中只显示置信度≥0.7的检测框
- ✅ 前端显示的置信度阈值为0.70
- ✅ 可以成功生成PDF格式的分析报告
- ✅ 报告包含完整的检测信息和可视化图像
- ✅ 报告格式专业，排版美观

---

## 故障排除

### 问题1：reportlab导入失败

**解决方案：**
```bash
pip install reportlab==4.0.7
```

### 问题2：PDF中文显示为方框

**原因：** 系统中没有安装中文字体

**解决方案：**
```bash
# Linux
sudo apt-get install fonts-wqy-zenhei

# 或者系统会自动使用英文报告（不影响功能）
```

### 问题3：报告生成失败

**检查步骤：**
1. 确认检测已完成，结果JSON文件存在
2. 检查可视化图像是否正常生成
3. 查看系统日志获取详细错误信息

**常见原因：**
- 可视化图像文件缺失
- 磁盘空间不足
- 文件权限问题

---

## 版本信息

- **系统版本：** TiCNet v1.0
- **更新日期：** 2025-10-22
- **Python版本：** ≥ 3.7
- **新增依赖：** reportlab 4.0.7

---

## 联系方式

如有问题或建议，请联系开发团队。

**参考论文：**
Ma, Ling and Li, Gen and Feng, Xingyu and Fan, Qiliang and Liu, Lizhi.  
*TiCNet: Transformer in Convolutional Neural Network for Pulmonary Nodule Detection on CT Images*

