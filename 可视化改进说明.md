# 可视化功能改进说明

## 📊 更新内容 (2025-10-22)

### ✅ 已完成的改进

#### 1️⃣ **去掉统计图表**
- ❌ 删除：Detection Statistics（检测统计柱状图）
- ❌ 删除：Confidence Distribution（置信度分布直方图）
- ✅ 原因：简化报告，聚焦于实际检测结果

#### 2️⃣ **增加切片显示数量**
- **原始切片图**：从6个增加到**9个**切片
- **汇总图**：从3个增加到**12个**切片（4x3网格布局）
- ✅ 更全面展示检测结果

#### 3️⃣ **添加真实标注框显示**
- **绿色虚线框** = Ground Truth (GT) 真实标注
- **红色实线框** = Prediction (Pred) 检测结果（置信度≥0.7）
- **标签说明**：
  - 绿色"GT"标签 - 真实标注
  - 红色置信度数值 - 检测结果
- ✅ 方便对比检测准确性

---

## 🎨 可视化效果

### 📁 原始切片图 (`_original_slices.png`)
- **布局**：3列 x 最多3行（9个切片）
- **切片选择**：智能选取有检测结果或GT的关键切片
- **显示内容**：
  - 灰度CT图像
  - 绿色虚线框：真实标注（如果有）
  - 红色实线框：检测结果（置信度≥0.7）
  - 标签：GT标签和置信度数值

### 📊 汇总图 (`_summary.png`)
- **布局**：4列 x 3行（12个切片）
- **切片选择策略**：
  1. 优先选择包含检测结果的切片
  2. 选择包含ground truth的切片
  3. 补充均匀分布的切片
- **显示内容**：
  - 每个切片显示深度百分比
  - 绿色虚线框：真实标注（带GT标签）
  - 红色实线框：检测结果（带置信度数值）
  - 顶部图例说明框的含义

---

## 🎯 框的区分

| 框类型 | 颜色 | 线型 | 标签 | 含义 |
|--------|------|------|------|------|
| **Ground Truth** | 🟢 亮绿色(lime) | 虚线 (--) | GT | 医生标注的真实结节位置 |
| **Detection** | 🔴 红色 (red) | 实线 (―) | 置信度 | 模型检测的结节位置（conf≥0.7） |

### 图例说明
报告中会自动添加图例：
- **检测框 (Pred, conf≥0.7)** - 红色实线
- **真实标注 (GT)** - 绿色虚线（仅在有标注数据时显示）

---

## 📝 修改的文件

### 1. `app.py`
```python
# 添加ground truth数据获取
ground_truth_boxes = []
if validation_result.get('has_ground_truth', False):
    truth_boxes, truth_labels = model_inference.annotation_handler.get_truth_data_for_image(
        file_path, results['meta_info']['spacing'],
        results['meta_info']['origin'], results['meta_info']['original_shape']
    )
    ground_truth_boxes = truth_boxes

# 传递给可视化器
visualization_paths = visualizer.create_visualizations(
    file_path, results, task_id, ground_truth_boxes=ground_truth_boxes
)
```

### 2. `system/visualization.py`

#### 修改函数签名
```python
def create_visualizations(self, image_path, results, task_id, ground_truth_boxes=None)
def _create_original_slices(self, image, task_id, detections, ground_truth_boxes=None)
def _create_detection_summary(self, image, task_id, detections, ground_truth_boxes=None)
```

#### 新增功能
- ✅ 自动检测并显示ground truth框
- ✅ 智能选择关键切片
- ✅ 增加切片数量（9个和12个）
- ✅ 添加颜色和样式区分
- ✅ 添加图例说明

---

## 🔍 切片选择逻辑

### 原始切片图（9个）
1. 收集所有包含检测结果的切片索引
2. 收集所有包含ground truth的切片索引
3. 如果不足9个，补充均匀分布的切片
4. 去重、排序后取前9个

### 汇总图（12个）
1. 收集置信度≥0.7的检测结果切片
2. 收集所有ground truth切片
3. 如果不足12个，补充12个均匀分布的切片
4. 去重、排序后取前12个

---

## 🚀 使用方法

### 重启Flask应用
```bash
# 停止当前服务 (Ctrl+C)
conda activate projectwcsnet
python run_system.py
```

### 测试效果
1. 进行CT图像检测
2. 查看结果页面
3. 检查可视化图像：
   - 应该看到更多切片（9个和12个）
   - 如果有真实标注，会显示绿色虚线框
   - 红色实线框显示检测结果

---

## 📌 注意事项

### Ground Truth 显示条件
- ✅ 必须是LUNA16数据集的图像
- ✅ 文件名或路径中包含seriesuid
- ✅ annotations.csv中有对应的标注数据
- ❌ 如果没有标注数据，只显示检测框（红色）

### 置信度过滤
- 可视化图像中**只显示置信度≥0.7的检测框**
- 所有检测结果仍保存在JSON文件中
- 可在详细结果表格中查看所有检测

---

## 🎨 颜色方案

| 元素 | 颜色代码 | 视觉效果 |
|------|----------|----------|
| GT框 | `lime` / `#00FF00` | 🟢 亮绿色虚线 |
| 检测框 | `red` / `#FF0000` | 🔴 红色实线 |
| GT标签背景 | `lime` alpha=0.4 | 🟢 半透明绿色 |
| 检测标签背景 | `red` alpha=0.4 | 🔴 半透明红色 |
| 框线宽度 | 2.5 | 粗线便于查看 |

---

## 📊 对比示例

### 改进前
- ❌ 只有3-6个切片
- ❌ 有统计图表占用空间
- ❌ 没有ground truth对比
- ❌ 检测效果难以评估

### 改进后
- ✅ 9-12个切片，更全面
- ✅ 无统计图，聚焦检测结果
- ✅ 绿色GT框显示真实标注
- ✅ 红色检测框显示预测结果
- ✅ 图例清晰说明
- ✅ 便于评估检测准确性

---

## 🔧 故障排除

### 问题1：看不到GT框
**原因：**
- 图像没有标注数据
- seriesuid提取失败
- annotations.csv不存在

**解决方案：**
- 检查文件名是否包含LUNA16的seriesuid格式
- 确认`annotations/annotations.csv`文件存在
- 查看系统日志了解详细信息

### 问题2：切片数量不足12个
**原因：**
- 正常情况，系统会自动补充切片

**说明：**
- 如果检测结果少于12个位置
- 系统会自动补充均匀分布的切片
- 确保总是显示12个切片

### 问题3：标签重叠
**原因：**
- GT框和检测框位置重叠

**设计：**
- GT标签在上方（y - 15）
- 检测标签在下方（y - 8）
- 有透明背景便于区分

---

## 📈 性能影响

- **生成时间**：增加约20%（更多切片绘制）
- **文件大小**：summary.png增大约30%
- **内存使用**：基本无影响
- **用户体验**：显著提升 ✨

---

## 🎯 未来改进建议

1. **交互式查看器** - 可缩放、平移的Web查看器
2. **3D可视化** - 立体显示检测结果
3. **动画切片** - GIF格式展示所有切片
4. **对比模式** - 并排显示GT和检测结果
5. **颜色自定义** - 允许用户选择框的颜色

---

## 📞 技术支持

如有问题或建议，请查看系统日志：
```bash
tail -f logs/system.log
```

---

**更新完成！重启Flask应用后生效。** 🎉

